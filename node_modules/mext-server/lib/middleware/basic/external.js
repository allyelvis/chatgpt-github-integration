'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true
});

const fs = require('fs-extra');

const path = require('path');
/**
 * External中间件
 *
 * 开发环境过滤/external请求开头的资源
 */

function External() {
  const external =
    JSON.parse(fs.readFileSync(path.join(this.dir, 'package.json'), 'utf-8')).external || {};
  const self = this;
  return async function ExternalMiddleware(ctx, next) {
    const config = self.config.toObject();
    const { assetPrefixs } = config; // http  //

    if (!/^http(s)?/.test(assetPrefixs) && !/^\/\//.test(assetPrefixs)) {
      const pathname = assetPrefixs + 'external/'; // <assetPrefixs>external/a.js

      const reg = new RegExp(`^${pathname}`);

      if (reg.test(ctx.request.url)) {
        const source = ctx.request.url.replace(reg, '').replace(/\?(.*)/, '');

        if (source) {
          // 匹配到资源了
          const reSource = external[source];

          if (reSource && !/^http(s)?/.test(reSource) && !/^\//.test(reSource)) {
            const filename = path.join(self.dir, reSource);

            if (fs.existsSync(filename)) {
              ctx.status = 200;
              ctx.type = path.extname(ctx.request.url);
              ctx.body = fs.readFileSync(filename);
              return;
            }
          }
        }
      }
    }

    await next();
  };
}

exports.default = External;
