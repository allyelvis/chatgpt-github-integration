'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true
});
/* eslint-disable array-callback-return */

/**
 * 处理第三方依赖的extensions扩展
 */

const fs = require('fs-extra');

const path_1 = require('path');

const constant_1 = require('./constant');

const dir = process.cwd();

exports.default = config => {
  const extensions = ['.css', '.less', '.scss'];
  const images = ['.jpg', '.png', '.jpeg', '.gif'];
  const cachePath = path_1.join(dir, config.server_dist, constant_1.default.IAMGECACHENAME);
  let map = {};

  if (fs.existsSync(cachePath)) {
    map = JSON.parse(fs.readFileSync(cachePath, 'utf-8'));
  }

  if (typeof require !== 'undefined') {
    [...extensions, ...images].map(item => {
      require.extensions[item] = data => {
        if (images.indexOf(item) !== -1) {
          let url = data.filename;

          if (!/^http(s)?:|^\/\//.test(url)) {
            const _path = path_1.relative(dir, url);

            if (map[_path]) {
              url = config.assetPrefixs + 'images/' + map[_path];
            }
          }

          data.exports = url;
        }
      };
    });
  }
};
